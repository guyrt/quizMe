{% extends "base.html" %}

{% block title %}
{{ doc_cluster.get_title }}
{% endblock %}

{% block customjs %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const reprocessButton = document.getElementById("js-reprocess");
    
        reprocessButton.addEventListener("click", function() {
            // Make an AJAX request to the reprocess URL
            fetch("{% url 'doc_cluster_reprocess' doc_cluster.id %}", {
                method: "POST", 
                body: JSON.stringify({}),
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                // Handle errors, if necessary
            });
        });
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
            return parts.pop().split(";").shift();
        }
    }
</script>
{% endblock %}

{% block leftnavcontent %}
<li class="nav-item">
    <a class="nav-link active" 
    href="{% url 'proposal_list' %}">Proposals</a>
</li>
{% endblock %}

{% block maincontent %}
    <header>
        <h1>{{ doc_cluster.get_title }}</h1>
    </header>
    <main>
        <div class="content">
            <a href="#">Original document</a> <!-- use https://github.com/coolwanglu/pdf2htmlEX -->
            <a href="{% url 'doc_cluster_raw' doc_cluster.id %}">Text Extraction details</a>
            <h2>List of Documents:</h2>
            {% for extract in doc_cluster.documentfile_set.all %}
            <p>{{ extract.file_role }}: {{ extract.doc_name }} - Processing status is {{ extract.processing_status }}</p>

            <div class="accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseTwo">
                            Summary
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                        {% if 'longsummary' in prompts %}
                            <p>{{ prompts.longsummary.as_html | safe }}</p>
                        {% else %}
                            <p>Processing....</p>
                        {% endif %}
                        </div> 
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                            People Mentioned
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                        {% if 'peoplesummary' in prompts %}
                            <p>{{ prompts.peoplesummary.as_html | safe }}</p>
                        {% else %}
                            <p>People Processing....</p>
                        {% endif %}
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
                            Questions Answered
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            {% if 'proposalquestions' in prompts %}
                                <p>{{ prompts.proposalquestions.as_html | safe }}</p>
                            {% else %}
                                <p>Questions Processing....</p>
                            {% endif %}
                    </div>
                </div>
            </div>

        {% empty %}
            <p>No extracts available</p>
        {% endfor %}

        <button id="js-reprocess" class="btn btn-primary">Reprocess everything</button>

        <div class="accordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingBottom">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBottom" aria-expanded="false" aria-controls="collapseBottom">
                        Raw Prompt Responses
                    </button>
                </h2>
                <div id="collapseBottom" class="accordion-collapse collapse" aria-labelledby="headingBottom" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        {% for prompt in all_prompts %}
                            <h3>{{ prompt.output_role }}</h3>
                            <p>ID: {{ prompt.id }}</p>
                            <p>{{ prompt.as_html | safe }}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
{% endblock %}